{% extends 'base/base.html' %}

{% block title %}Registrar Jugador - {{ club.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-1 md:px-4 py-2 md:py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm breadcrumbs mb-2">
            <a href="{% url 'home' %}" class="link link-hover">Inicio</a>
            <span>/</span>
            <a href="{% url 'clubs:players_list' club_id=club.id %}" class="link link-hover">Jugadores</a>
            <span>/</span>
            <span class="text-gray-600">Registrar Jugador</span>
        </div>
        <h1 class="text-3xl font-bold text-lime-700 flex items-center">
            <i class="las la-user-plus text-4xl mr-2"></i>
            Registrar Nuevo Jugador
        </h1>
        <p class="text-gray-600 mt-2">Complete el formulario para registrar un jugador en {{ club.name }}</p>
    </div>

    <!-- Form Card -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <!-- Informaci√≥n Personal -->
                <div>
                    <h3 class="text-lg font-semibold text-lime-600 border-b pb-2 mb-4 flex items-center">
                        <i class="las la-id-card text-xl mr-2"></i>
                        Informaci√≥n Personal
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label" for="national_id">
                                <span class="label-text">C√©dula <span class="text-error">*</span></span>
                            </label>
                            <input type="text" 
                                   id="national_id" 
                                   name="national_id" 
                                   class="input input-bordered" 
                                   placeholder="Ej: 0123456789"
                                   maxlength="10"
                                   value="{{ form_data.national_id|default:'' }}"
                                   required>
                            <label class="label">
                                <span class="label-text-alt text-info" id="player-check-message">Se verificar√° si el jugador ya existe</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label" for="email">   
                                <span class="label-text">Correo Electr√≥nico</span>
                            </label>
                            <input type="email" 
                                   id="email" 
                                   name="email" 
                                   class="input input-bordered" 
                                   placeholder="jugador@email.com"
                                   value="{{ form_data.email|default:'' }}">
                        </div>

                        <div class="form-control">
                            <label class="label" for="first_name">
                                <span class="label-text">Nombres <span class="text-error">*</span></span>
                            </label>
                            <input type="text" 
                                   id="first_name" 
                                   name="first_name" 
                                   class="input input-bordered" 
                                   placeholder="Ej: Juan Carlos"
                                   value="{{ form_data.first_name|default:'' }}"
                                   required>
                        </div>

                        <div class="form-control">
                            <label class="label" for="last_name">
                                <span class="label-text">Apellidos <span class="text-error">*</span></span>
                            </label>
                            <input type="text" 
                                   id="last_name" 
                                   name="last_name" 
                                   class="input input-bordered" 
                                   placeholder="Ej: P√©rez Garc√≠a"
                                   value="{{ form_data.last_name|default:'' }}"
                                   required>
                        </div>

                        <div class="form-control">
                            <label class="label" for="birth_date">
                                <span class="label-text">Fecha de Nacimiento</span>
                                <span class="label-text-alt text-primary font-semibold" id="age-display"></span>
                            </label>
                            <input type="date" 
                                   id="birth_date" 
                                   name="birth_date" 
                                   class="input input-bordered"
                                   value="{{ form_data.birth_date|default:'' }}">
                            <label class="label">
                                <span class="label-text-alt" id="age-category-hint"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n de Registro -->
                <div>
                    <h3 class="text-lg font-semibold text-lime-600 border-b pb-2 mb-4 flex items-center">
                        <i class="las la-futbol text-xl mr-2"></i>
                        Informaci√≥n de Registro
                    </h3>
                    
                    <!-- Mostrar informaci√≥n de la categor√≠a seleccionada -->
                    <div id="category-info" class="alert alert-info mb-4" style="display: none;">
                        <i class="las la-info-circle text-xl"></i>
                        <div>
                            <p class="font-semibold">Informaci√≥n de la Categor√≠a:</p>
                            <ul id="category-details" class="text-sm mt-1 space-y-1"></ul>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label" for="season_id">
                                <span class="label-text">Temporada / Categor√≠a <span class="text-error">*</span></span>
                            </label>
                            <select id="season_id" 
                                    name="season_id" 
                                    class="select select-bordered" 
                                    required>
                                <option value="">Seleccione una temporada</option>
                                {% for season in seasons %}
                                <option value="{{ season.id }}" 
                                        data-category="{{ season.categorie.name }}"
                                        data-min-age="{{ season.categorie.min_age|default:'' }}"
                                        data-max-players="{{ season.categorie.max_players }}"
                                        data-max-youth="{{ season.categorie.max_youth_player }}"
                                        data-min-youth-num="{{ season.categorie.min_number_youth_player }}"
                                        data-max-youth-num="{{ season.categorie.max_number_youth_player }}"
                                        data-min-adult-num="{{ season.categorie.min_number_player }}"
                                        data-max-adult-num="{{ season.categorie.max_number_player }}"
                                        {% if form_data.season_id == season.id|stringformat:"i" %}selected{% endif %}>
                                    {{ season.categorie.name }} - {{ season.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label" for="number">
                                <span class="label-text">N√∫mero de Jugador <span class="text-error">*</span></span>
                                <span class="label-text-alt" id="number-range-hint"></span>
                            </label>
                            <input type="number" 
                                   id="number" 
                                   name="number" 
                                   class="input input-bordered" 
                                   min="1" 
                                   max="999"
                                   placeholder="Ej: 10"
                                   value="{{ form_data.number|default:'' }}"
                                   required>
                            <label class="label">
                                <span class="label-text-alt text-warning" id="number-validation-msg"></span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-3" for="is_requalification">
                                <input type="checkbox" 
                                       id="is_requalification"
                                       name="is_requalification" 
                                       class="checkbox checkbox-sm checkbox-primary"
                                       {% if form_data.is_requalification == 'on' %}checked{% endif %}>
                                <span class="label-text">¬øEs recalificaci√≥n?</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-3" for="have_pass">
                                <input type="checkbox" 
                                       id="have_pass"
                                       name="have_pass" 
                                       class="checkbox checkbox-sm checkbox-primary"
                                       {% if form_data.have_pass == 'on' %}checked{% endif %}>
                                <span class="label-text">¬øTiene pase?</span>
                            </label>
                        </div>

                        <div class="form-control md:col-span-2" id="before_club_container" style="display: none;">
                            <label class="label" for="before_club">
                                <span class="label-text">Club Anterior</span>
                            </label>
                            <input type="text" 
                                   id="before_club" 
                                   name="before_club" 
                                   class="input input-bordered" 
                                   placeholder="Nombre del club anterior"
                                   value="{{ form_data.before_club|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Documentos -->
                <div>
                    <h3 class="text-lg font-semibold text-lime-600 border-b pb-2 mb-4 flex items-center">
                        <i class="las la-file-upload text-xl mr-2"></i>
                        Documentos
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control">
                            <label class="label" for="photo">
                                <span class="label-text">Foto (fondo claro)</span>
                            </label>
                            <input type="file" 
                                   id="photo" 
                                   name="photo" 
                                   class="file-input file-input-bordered file-input-sm w-full"
                                   accept="image/*">
                            <label class="label">
                                <span class="label-text-alt">JPG, PNG (Max: 5MB)</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label" for="id_document">
                                <span class="label-text">Foto de C√©dula</span>
                            </label>
                            <input type="file" 
                                   id="id_document" 
                                   name="id_document" 
                                   class="file-input file-input-bordered file-input-sm w-full"
                                   accept="image/*,application/pdf">
                            <label class="label">
                                <span class="label-text-alt">JPG, PNG, PDF (Max: 5MB)</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label" for="minor_authorization">
                                <span class="label-text">Autorizaci√≥n (menores) <span id="minor-required" class="text-error" style="display: none;">*</span></span>
                            </label>
                            <input type="file" 
                                   id="minor_authorization" 
                                   name="minor_authorization" 
                                   class="file-input file-input-bordered file-input-sm w-full"
                                   accept="image/*,application/pdf">
                            <label class="label">
                                <span class="label-text-alt" id="minor-hint">JPG, PNG, PDF (Max: 5MB)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="flex justify-end gap-2 pt-4 border-t">
                    <a href="{% url 'clubs:players_list' club_id=club.id %}" class="btn btn-ghost">
                        <i class="las la-times"></i> Cancelar
                    </a>
                    <button type="submit" name="save_and_new" id="save-and-new-btn" class="btn btn-outline btn-primary">
                        <i class="las la-save"></i> Guardar y Nuevo
                    </button>
                    <button type="submit" name="save" id="save-btn" class="btn btn-primary">
                        <i class="las la-check"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let playerCheckTimeout;
    let playerExists = false;
    let playerData = null;
    let categoryRules = null;
    let numberCheckTimeout;
    let formIsValid = false;

    // Funci√≥n para verificar si el jugador existe
    async function checkPlayerExists(nationalId) {
        if (!nationalId || nationalId.length < 10) {
            document.getElementById('player-check-message').textContent = 'Se verificar√° si el jugador ya existe';
            document.getElementById('player-check-message').className = 'label-text-alt text-info';
            return;
        }

        try {
            const response = await fetch(`{% url 'clubs:api_check_player' %}?national_id=${nationalId}`);
            const data = await response.json();
            
            if (data.success && data.exists) {
                playerExists = true;
                playerData = data;
                
                // Actualizar campos del formulario con datos existentes
                document.getElementById('first_name').value = data.player.first_name;
                document.getElementById('last_name').value = data.player.last_name;
                if (data.player.email) {
                    document.getElementById('email').value = data.player.email;
                }
                if (data.player.birth_date) {
                    document.getElementById('birth_date').value = data.player.birth_date;
                }
                
                // Mostrar informaci√≥n del club actual
                let message = `Jugador existente: ${data.player.full_name}`;
                if (data.current_registration) {
                    message += ` (Club actual: ${data.current_registration.club.name})`;
                    document.getElementById('player-check-message').className = 'label-text text-lg font-semibold text-red-800';
                } else if (data.last_registration) {
                    message += ` (√öltimo club: ${data.last_registration.club.name})`;
                    document.getElementById('player-check-message').className = 'label-text text-base font-medium text-info';
                }
                
                document.getElementById('player-check-message').textContent = message;
                
            } else {
                playerExists = false;
                playerData = null;
                document.getElementById('player-check-message').textContent = 'Jugador nuevo - se crear√° un registro';
                document.getElementById('player-check-message').className = 'label-text text-base font-medium text-success';
            }
        } catch (error) {
            console.error('Error checking player:', error);
            document.getElementById('player-check-message').textContent = 'ERROR: No se pudo verificar el jugador. Revise su conexi√≥n.';
            document.getElementById('player-check-message').className = 'label-text text-lg font-bold text-error bg-error bg-opacity-10 p-2 rounded';
        }
    }

    // Mostrar/ocultar campo de club anterior basado solo en el checkbox "have_pass"
    function toggleBeforeClub() {
        const havePassCheckbox = document.getElementById('have_pass');
        const container = document.getElementById('before_club_container');
        
        if (havePassCheckbox && container) {
            container.style.display = havePassCheckbox.checked ? 'block' : 'none';
        }
    }

    // Funci√≥n para calcular edad
    function calculateAge(birthDate) {
        if (!birthDate) return null;
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    // Nueva funci√≥n para mostrar la edad calculada
    function displayAge() {
        const birthDate = document.getElementById('birth_date').value;
        const ageDisplay = document.getElementById('age-display');
        const ageCategoryHint = document.getElementById('age-category-hint');
        
        if (!birthDate) {
            ageDisplay.textContent = '';
            ageCategoryHint.textContent = '';
            validateForm(); // Validar formulario
            return;
        }
        
        const age = calculateAge(birthDate);
        
        if (age !== null) {
            // Mostrar edad
            ageDisplay.textContent = `(${age} a√±os)`;
            
            // Determinar si es juvenil o adulto seg√∫n la categor√≠a seleccionada
            if (categoryRules) {
                if (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') {
                    if (age < 18) {
                        ageCategoryHint.textContent = 'üë∂ Jugador Juvenil (menor de 18 a√±os)';
                        ageCategoryHint.className = 'label-text-alt text-info font-medium';
                    } else {
                        ageCategoryHint.textContent = 'üë§ Jugador Adulto';
                        ageCategoryHint.className = 'label-text-alt text-success font-medium';
                    }
                } else {
                    // Para otras categor√≠as, verificar edad m√≠nima
                    if (categoryRules.minAge && age < categoryRules.minAge) {
                        ageCategoryHint.textContent = `‚ö†Ô∏è Edad insuficiente (m√≠nimo ${categoryRules.minAge} a√±os) - NO PUEDE CONTINUAR`;
                        ageCategoryHint.className = 'label-text-alt text-error font-bold text-base';
                    } else {
                        ageCategoryHint.textContent = '‚úì Edad v√°lida para la categor√≠a';
                        ageCategoryHint.className = 'label-text-alt text-success font-medium';
                    }
                }
            } else {
                // Si no hay categor√≠a seleccionada, solo mostrar si es menor o mayor de edad
                if (age < 18) {
                    ageCategoryHint.textContent = 'Menor de edad';
                    ageCategoryHint.className = 'label-text-alt text-info';
                } else {
                    ageCategoryHint.textContent = 'Mayor de edad';
                    ageCategoryHint.className = 'label-text-alt text-base';
                }
            }
            
            // Cambiar color de la edad seg√∫n rango
            if (age < 18) {
                ageDisplay.className = 'label-text-alt text-info font-semibold';
            } else if (age >= 35) {
                ageDisplay.className = 'label-text-alt text-warning font-semibold';
            } else {
                ageDisplay.className = 'label-text-alt text-primary font-semibold';
            }
        } else {
            ageDisplay.textContent = '';
            ageCategoryHint.textContent = 'Fecha inv√°lida';
            ageCategoryHint.className = 'label-text-alt text-error';
        }
        
        // Actualizar el rango de n√∫meros permitidos
        updateNumberRange();
        
        // Validar formulario completo
        validateForm();
    }

    // Funci√≥n para actualizar informaci√≥n de categor√≠a
    function updateCategoryInfo() {
        const seasonSelect = document.getElementById('season_id');
        const selectedOption = seasonSelect.options[seasonSelect.selectedIndex];
        const categoryInfo = document.getElementById('category-info');
        const categoryDetails = document.getElementById('category-details');
        const numberInput = document.getElementById('number');
        const numberRangeHint = document.getElementById('number-range-hint');
        const birthDateInput = document.getElementById('birth_date');
        
        if (!selectedOption || !selectedOption.value) {
            categoryInfo.style.display = 'none';
            numberRangeHint.textContent = '';
            categoryRules = null; // Limpiar reglas
            displayAge(); // Actualizar display de edad
            return;
        }
        
        // Obtener datos de la categor√≠a
        categoryRules = {
            name: selectedOption.dataset.category,
            minAge: parseInt(selectedOption.dataset.minAge) || null,
            maxPlayers: parseInt(selectedOption.dataset.maxPlayers),
            maxYouth: parseInt(selectedOption.dataset.maxYouth),
            minYouthNum: parseInt(selectedOption.dataset.minYouthNum),
            maxYouthNum: parseInt(selectedOption.dataset.maxYouthNum),
            minAdultNum: parseInt(selectedOption.dataset.minAdultNum),
            maxAdultNum: parseInt(selectedOption.dataset.maxAdultNum)
        };
        
        // Actualizar informaci√≥n visible
        let details = [];
        details.push(`<li>‚Ä¢ M√°ximo de jugadores: ${categoryRules.maxPlayers}</li>`);
        if (categoryRules.minAge) {
            details.push(`<li>‚Ä¢ Edad m√≠nima: ${categoryRules.minAge} a√±os</li>`);
        }
        details.push(`<li>‚Ä¢ N√∫meros adultos: ${categoryRules.minAdultNum} - ${categoryRules.maxAdultNum}</li>`);
        details.push(`<li>‚Ä¢ N√∫meros juveniles (menores 18): ${categoryRules.minYouthNum} - ${categoryRules.maxYouthNum}</li>`);
        details.push(`<li>‚Ä¢ M√°ximo juveniles: ${categoryRules.maxYouth}</li>`);
        
        categoryDetails.innerHTML = details.join('');
        categoryInfo.style.display = 'flex';
        
        // Actualizar display de edad con las nuevas reglas de categor√≠a
        displayAge();
        
        // Actualizar rango de n√∫meros seg√∫n edad
        updateNumberRange();
    }
    
    // Funci√≥n para actualizar el rango de n√∫meros permitidos
    function updateNumberRange() {
        if (!categoryRules) return;
        
        const birthDate = document.getElementById('birth_date').value;
        const numberInput = document.getElementById('number');
        const numberRangeHint = document.getElementById('number-range-hint');
        const minorRequired = document.getElementById('minor-required');
        const minorHint = document.getElementById('minor-hint');
        
        const age = calculateAge(birthDate);
        let isYouth = false;
        
        // Determinar si es juvenil para SENIOR y FEMENINO
        if (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') {
            isYouth = age !== null && age < 18;
        }
        
        if (isYouth) {
            numberInput.min = categoryRules.minYouthNum;
            numberInput.max = categoryRules.maxYouthNum;
            numberRangeHint.textContent = `(${categoryRules.minYouthNum} - ${categoryRules.maxYouthNum})`;
            numberRangeHint.className = 'label-text-alt text-info';
            
            // Hacer obligatoria la autorizaci√≥n
            minorRequired.style.display = 'inline';
            minorHint.textContent = 'Obligatorio para menores de 18 a√±os';
            minorHint.className = 'label-text-alt text-warning';
        } else {
            numberInput.min = categoryRules.minAdultNum;
            numberInput.max = categoryRules.maxAdultNum;
            numberRangeHint.textContent = `(${categoryRules.minAdultNum} - ${categoryRules.maxAdultNum})`;
            numberRangeHint.className = 'label-text-alt';
            
            // Quitar obligatoriedad de autorizaci√≥n
            minorRequired.style.display = 'none';
            minorHint.textContent = 'JPG, PNG, PDF (Max: 5MB)';
            minorHint.className = 'label-text-alt';
        }
        
        // Validar n√∫mero actual
        validateNumber();
    }
    
    // Nueva funci√≥n para validar todo el formulario
    function validateForm() {
        const saveBtn = document.getElementById('save-btn');
        const saveAndNewBtn = document.getElementById('save-and-new-btn');
        const birthDate = document.getElementById('birth_date').value;
        const seasonId = document.getElementById('season_id').value;
        const numberInput = document.getElementById('number');
        const number = parseInt(numberInput.value);
        
        let isValid = true;
        let errorMessages = [];
        
        // Validar que haya temporada seleccionada
        if (!seasonId || !categoryRules) {
            isValid = false;
            errorMessages.push('Debe seleccionar una temporada');
        }
        
        // Validar edad m√≠nima si la categor√≠a lo requiere
        if (categoryRules && categoryRules.minAge && birthDate) {
            const age = calculateAge(birthDate);
            if (age !== null && age < categoryRules.minAge) {
                isValid = false;
                errorMessages.push(`El jugador debe tener al menos ${categoryRules.minAge} a√±os`);
            }
        }
        
        // Validar n√∫mero
        if (categoryRules && number) {
            const age = calculateAge(birthDate);
            let isYouth = (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') && age !== null && age < 18;
            
            if (isYouth) {
                if (number < categoryRules.minYouthNum || number > categoryRules.maxYouthNum) {
                    isValid = false;
                    errorMessages.push(`N√∫mero debe estar entre ${categoryRules.minYouthNum} y ${categoryRules.maxYouthNum} (juvenil)`);
                }
            } else {
                if (number < categoryRules.minAdultNum || number > categoryRules.maxAdultNum) {
                    isValid = false;
                    errorMessages.push(`N√∫mero debe estar entre ${categoryRules.minAdultNum} y ${categoryRules.maxAdultNum} (adulto)`);
                }
            }
            
            // Verificar si el n√∫mero tiene la clase input-error (ya est√° asignado)
            if (numberInput.classList.contains('input-error')) {
                isValid = false;
                errorMessages.push('El n√∫mero ya est√° asignado');
            }
        }
        
        // Actualizar estado de los botones
        if (isValid) {
            saveBtn.disabled = false;
            saveAndNewBtn.disabled = false;
            saveBtn.classList.remove('btn-disabled');
            saveAndNewBtn.classList.remove('btn-disabled');
            formIsValid = true;
        } else {
            saveBtn.disabled = true;
            saveAndNewBtn.disabled = true;
            saveBtn.classList.add('btn-disabled');
            saveAndNewBtn.classList.add('btn-disabled');
            formIsValid = false;
            
            // Mostrar tooltip con errores
            if (errorMessages.length > 0) {
                saveBtn.title = 'Errores:\n' + errorMessages.join('\n');
                saveAndNewBtn.title = 'Errores:\n' + errorMessages.join('\n');
            }
        }
        
        return isValid;
    }
    
    // Funci√≥n para validar n√∫mero de jugador
    async function validateNumber() {
        const numberInput = document.getElementById('number');
        const number = parseInt(numberInput.value);
        const validationMsg = document.getElementById('number-validation-msg');
        const seasonId = document.getElementById('season_id').value;
        const clubId = {{ club.id }};
        
        if (!number || !seasonId || !categoryRules) {
            validationMsg.textContent = '';
            validateForm(); // Validar formulario completo
            return;
        }
        
        // Verificar rango local primero
        const birthDate = document.getElementById('birth_date').value;
        const age = calculateAge(birthDate);
        let isYouth = (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') && age !== null && age < 18;
        
        let validRange = true;
        if (isYouth) {
            validRange = number >= categoryRules.minYouthNum && number <= categoryRules.maxYouthNum;
            if (!validRange) {
                validationMsg.textContent = `N√∫mero fuera del rango juvenil (${categoryRules.minYouthNum} - ${categoryRules.maxYouthNum})`;
                validationMsg.className = 'label-text-alt text-error font-bold';
                numberInput.classList.add('input-error');
                numberInput.classList.remove('input-success');
                validateForm(); // Validar formulario completo
                return;
            }
        } else {
            validRange = number >= categoryRules.minAdultNum && number <= categoryRules.maxAdultNum;
            if (!validRange) {
                validationMsg.textContent = `N√∫mero fuera del rango adulto (${categoryRules.minAdultNum} - ${categoryRules.maxAdultNum})`;
                validationMsg.className = 'label-text-alt text-error font-bold';
                numberInput.classList.add('input-error');
                numberInput.classList.remove('input-success');
                validateForm(); // Validar formulario completo
                return;
            }
        }
        
        // Verificar disponibilidad del n√∫mero con llamada AJAX
        try {
            validationMsg.textContent = 'Verificando disponibilidad...';
            validationMsg.className = 'label-text-alt text-info';
            
            const response = await fetch(`/api/check-player-number/?number=${number}&season_id=${seasonId}&club_id=${clubId}`);
            const data = await response.json();
            
            if (data.success) {
                if (data.available) {
                    validationMsg.textContent = '‚úì N√∫mero disponible';
                    validationMsg.className = 'label-text-alt text-success font-semibold';
                    numberInput.classList.remove('input-error');
                    numberInput.classList.add('input-success');
                } else {
                    validationMsg.textContent = `‚úó ${data.message}`;
                    validationMsg.className = 'label-text-alt text-error font-semibold';
                    numberInput.classList.remove('input-success');
                    numberInput.classList.add('input-error');
                }
                
                // Mostrar advertencia si est√° fuera de rango
                if (data.warning) {
                    validationMsg.textContent += ` - ${data.warning}`;
                }
            } else {
                validationMsg.textContent = data.error || 'Error al verificar el n√∫mero';
                validationMsg.className = 'label-text-alt text-error';
                numberInput.classList.remove('input-success');
                numberInput.classList.add('input-error');
            }
        } catch (error) {
            console.error('Error checking number:', error);
            validationMsg.textContent = 'Error de conexi√≥n al verificar n√∫mero';
            validationMsg.className = 'label-text-alt text-warning';
        } finally {
            // Validar formulario completo despu√©s de verificar n√∫mero
            validateForm();
        }
    }

    // Ejecutar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        toggleBeforeClub();
        updateCategoryInfo();
        displayAge(); // Mostrar edad si ya hay fecha cargada
        validateForm(); // Validar formulario al cargar
        
        // Agregar listener al checkbox have_pass
        const havePassCheckbox = document.getElementById('have_pass');
        if (havePassCheckbox) {
            havePassCheckbox.addEventListener('change', toggleBeforeClub);
        }
        
        // Agregar listener para cambio de temporada
        const seasonSelect = document.getElementById('season_id');
        if (seasonSelect) {
            seasonSelect.addEventListener('change', function() {
                updateCategoryInfo();
                validateForm(); // Validar al cambiar temporada
            });
        }
        
        // Agregar listener para cambio de fecha de nacimiento
        const birthDateInput = document.getElementById('birth_date');
        if (birthDateInput) {
            birthDateInput.addEventListener('change', function() {
                displayAge();
            });
            // Tambi√©n actualizar cuando se escribe
            birthDateInput.addEventListener('input', function() {
                displayAge();
            });
        }
        
        // Agregar listener para validar n√∫mero con debounce
        const numberInput = document.getElementById('number');
        if (numberInput) {
            numberInput.addEventListener('input', function() {
                // Limpiar timeout anterior
                clearTimeout(numberCheckTimeout);
                
                // Limpiar clases de validaci√≥n
                this.classList.remove('input-success', 'input-error');
                
                // Verificar despu√©s de 500ms de inactividad
                numberCheckTimeout = setTimeout(() => {
                    validateNumber();
                }, 500);
            });
        }
        
        // Agregar listener para verificar jugador
        const nationalIdInput = document.getElementById('national_id');
        nationalIdInput.addEventListener('input', function(e) {
            // Limpiar timeout anterior
            clearTimeout(playerCheckTimeout);
            
            // Validar solo n√∫meros
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Opcional: Validar longitud para c√©dula ecuatoriana
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
            
            // Verificar jugador despu√©s de 500ms de inactividad
            playerCheckTimeout = setTimeout(() => {
                checkPlayerExists(this.value);
            }, 500);
        });
        
        // Prevenir env√≠o si el formulario no es v√°lido
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (!formIsValid) {
                    e.preventDefault();
                    alert('Por favor, corrija los errores antes de continuar:\n\n' + 
                          (categoryRules && categoryRules.minAge && calculateAge(document.getElementById('birth_date').value) < categoryRules.minAge 
                           ? `- El jugador debe tener al menos ${categoryRules.minAge} a√±os\n` 
                           : '') +
                          (document.getElementById('number').classList.contains('input-error') 
                           ? '- El n√∫mero seleccionado no est√° disponible o est√° fuera del rango permitido\n' 
                           : '')
                    );
                    return false;
                }
            });
        }
    });
</script>
{% endblock %}
