{% extends 'base/base.html' %}

{% block title %}Registrar Jugador - {{ club.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-1 md:px-4 py-2 md:py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm breadcrumbs mb-2">
            <a href="{% url 'home' %}" class="link link-hover">Inicio</a>
            <span>/</span>
            <a href="{% url 'clubs:players_list' club_id=club.id %}" class="link link-hover">Jugadores</a>
            <span>/</span>
            <span class="text-gray-600">Registrar Jugador</span>
        </div>
        <h1 class="text-3xl font-bold text-lime-700 flex items-center">
            <i class="las la-user-plus text-4xl mr-2"></i>
            Registrar Nuevo Jugador
        </h1>
        <p class="text-gray-600 mt-2">Complete el formulario para registrar un jugador en {{ club.name }}</p>
    </div>

    <!-- Form Card -->
    <div class="card bg-base-100 shadow-lg">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" class="space-y-6">
                {% csrf_token %}
                
                <!-- Informaci√≥n Personal -->
                <div>
                    <h3 class="text-lg font-semibold text-lime-600 border-b pb-2 mb-4 flex items-center">
                        <i class="las la-id-card text-xl mr-2"></i>
                        Informaci√≥n Personal
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label" for="national_id">
                                <span class="label-text">C√©dula <span class="text-error">*</span></span>
                            </label>
                            <input type="text" 
                                   id="national_id" 
                                   name="national_id" 
                                   class="input input-bordered" 
                                   placeholder="Ej: 0123456789"
                                   maxlength="10"
                                   value="{{ form_data.national_id|default:'' }}"
                                   required>
                            <label class="label">
                                <span class="label-text-alt text-info" id="player-check-message">Se verificar√° si el jugador ya existe</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label" for="season_id">
                                <span class="label-text">Temporada / Categor√≠a <span class="text-error">*</span></span>
                            </label>
                            <select id="season_id" 
                                    name="season_id" 
                                    class="select select-bordered" 
                                    required>
                                <option value="">Seleccione una temporada</option>
                                {% for season in seasons %}
                                <option value="{{ season.id }}" 
                                        data-category="{{ season.categorie.name }}"
                                        data-min-age="{{ season.categorie.min_age|default:'' }}"
                                        data-max-players="{{ season.categorie.max_players }}"
                                        data-max-youth="{{ season.categorie.max_youth_player }}"
                                        data-min-youth-num="{{ season.categorie.min_number_youth_player }}"
                                        data-max-youth-num="{{ season.categorie.max_number_youth_player }}"
                                        data-min-adult-num="{{ season.categorie.min_number_player }}"
                                        data-max-adult-num="{{ season.categorie.max_number_player }}"
                                        {% if form_data.season_id == season.id|stringformat:"i" %}selected{% endif %}>
                                    {{ season.categorie.name }} - {{ season.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-control">
                            <label class="label" for="first_name">
                                <span class="label-text">Nombres <span class="text-error">*</span></span>
                            </label>
                            <input type="text" 
                                   id="first_name" 
                                   name="first_name" 
                                   class="input input-bordered" 
                                   placeholder="Ej: Juan Carlos"
                                   value="{{ form_data.first_name|default:'' }}"
                                   required>
                        </div>

                        <div class="form-control">
                            <label class="label" for="last_name">
                                <span class="label-text">Apellidos <span class="text-error">*</span></span>
                            </label>
                            <input type="text" 
                                   id="last_name" 
                                   name="last_name" 
                                   class="input input-bordered" 
                                   placeholder="Ej: P√©rez Garc√≠a"
                                   value="{{ form_data.last_name|default:'' }}"
                                   required>
                        </div>

                        <div class="form-control">
                            <label class="label" for="birth_date">
                                <span class="label-text">Fecha de Nacimiento</span>
                                <span class="label-text-alt text-primary font-semibold" id="age-display"></span>
                            </label>
                            <input type="date" 
                                   id="birth_date" 
                                   name="birth_date" 
                                   class="input input-bordered"
                                   value="{{ form_data.birth_date|default:'' }}">
                            <label class="label">
                                <span class="label-text-alt" id="age-category-hint"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n de Registro -->
                <div>
                    <h3 class="text-lg font-semibold text-lime-600 border-b pb-2 mb-4 flex items-center">
                        <i class="las la-futbol text-xl mr-2"></i>
                        Informaci√≥n de Registro
                    </h3>
                    
                    <!-- Mostrar informaci√≥n de la categor√≠a seleccionada -->
                    <div id="category-info" class="alert alert-info mb-4" style="display: none;">
                        <i class="las la-info-circle text-xl"></i>
                        <div>
                            <p class="font-semibold">Informaci√≥n de la Categor√≠a:</p>
                            <ul id="category-details" class="text-sm mt-1 space-y-1"></ul>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">
                            <label class="label" for="number">
                                <span class="label-text">N√∫mero de Jugador <span class="text-error">*</span></span>
                                <span class="label-text-alt" id="number-range-hint"></span>
                            </label>
                            <input type="number" 
                                   id="number" 
                                   name="number" 
                                   class="input input-bordered" 
                                   min="1" 
                                   max="999"
                                   placeholder="Ej: 10"
                                   value="{{ form_data.number|default:'' }}"
                                   required>
                            <label class="label">
                                <span class="label-text-alt text-warning" id="number-validation-msg"></span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-3" for="is_requalification">
                                <input type="checkbox" 
                                       id="is_requalification"
                                       name="is_requalification" 
                                       class="checkbox checkbox-sm checkbox-primary"
                                       {% if form_data.is_requalification == 'on' %}checked{% endif %}>
                                <span class="label-text">¬øEs recalificaci√≥n?</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label cursor-pointer justify-start gap-3" for="have_pass">
                                <input type="checkbox" 
                                       id="have_pass"
                                       name="have_pass" 
                                       class="checkbox checkbox-sm checkbox-primary"
                                       {% if form_data.have_pass == 'on' %}checked{% endif %}>
                                <span class="label-text">¬øTiene pase?</span>
                            </label>
                        </div>

                        <div class="form-control md:col-span-2" id="before_club_container" style="display: none;">
                            <label class="label" for="before_club">
                                <span class="label-text">Club Anterior</span>
                            </label>
                            <input type="text" 
                                   id="before_club" 
                                   name="before_club" 
                                   class="input input-bordered" 
                                   placeholder="Nombre del club anterior"
                                   value="{{ form_data.before_club|default:'' }}">
                        </div>
                    </div>
                </div>

                <!-- Documentos -->
                <div>
                    <h3 class="text-lg font-semibold text-lime-600 border-b pb-2 mb-4 flex items-center">
                        <i class="las la-file-upload text-xl mr-2"></i>
                        Documentos
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control">
                            <label class="label" for="photo">
                                <span class="label-text">Foto (fondo claro)</span>
                            </label>
                            <input type="file" 
                                   id="photo" 
                                   name="photo" 
                                   class="file-input file-input-bordered file-input-sm w-full"
                                   accept="image/*">
                            <label class="label">
                                <span class="label-text-alt">JPG, PNG (Max: 5MB)</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label" for="id_document">
                                <span class="label-text">Foto de C√©dula</span>
                            </label>
                            <input type="file" 
                                   id="id_document" 
                                   name="id_document" 
                                   class="file-input file-input-bordered file-input-sm w-full"
                                   accept="image/*,application/pdf">
                            <label class="label">
                                <span class="label-text-alt">JPG, PNG, PDF (Max: 5MB)</span>
                            </label>
                        </div>

                        <div class="form-control">
                            <label class="label" for="minor_authorization">
                                <span class="label-text">Autorizaci√≥n (menores) <span id="minor-required" class="text-error" style="display: none;">*</span></span>
                            </label>
                            <input type="file" 
                                   id="minor_authorization" 
                                   name="minor_authorization" 
                                   class="file-input file-input-bordered file-input-sm w-full"
                                   accept="image/*,application/pdf">
                            <label class="label">
                                <span class="label-text-alt" id="minor-hint">JPG, PNG, PDF (Max: 5MB)</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="flex justify-end gap-2 pt-4 border-t">
                    <a href="{% url 'clubs:players_list' club_id=club.id %}" class="btn btn-ghost">
                        <i class="las la-times"></i> Cancelar
                    </a>
                    <button type="submit" name="save_and_new" id="save-and-new-btn" class="btn btn-outline btn-primary">
                        <i class="las la-save"></i> Guardar y Nuevo
                    </button>
                    <button type="submit" name="save" id="save-btn" class="btn btn-primary">
                        <i class="las la-check"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let playerCheckTimeout;
    let playerExists = false;
    let playerData = null;
    let categoryRules = null;
    let numberCheckTimeout;
    let formIsValid = false;

    // Funci√≥n para verificar si el jugador existe
    async function checkPlayerExists(nationalId) {
        if (!nationalId || nationalId.length < 10) {
            document.getElementById('player-check-message').textContent = 'Se verificar√° si el jugador ya existe';
            document.getElementById('player-check-message').className = 'label-text-alt text-info';
            resetPlayerValidation();
            enableAllSeasons(); // Habilitar todas las temporadas
            return;
        }

        try {
            // Mostrar mensaje de carga
            displayPlayerInfo('üîç Verificando jugador...');
            
            // Incluir season_id en la consulta si hay una temporada seleccionada
            const seasonSelect = document.getElementById('season_id');
            const seasonId = seasonSelect ? seasonSelect.value : '';
            const url = seasonId ? 
                `{% url 'clubs:api_check_player' %}?national_id=${nationalId}&season_id=${seasonId}` :
                `{% url 'clubs:api_check_player' %}?national_id=${nationalId}`;
                
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.exists) {
                playerExists = true;
                playerData = data;
                
                // Actualizar campos del formulario con datos existentes
                updateFormWithPlayerData(data.player);
                
                // Deshabilitar temporadas donde ya est√° registrado
                disableOccupiedSeasons(data);
                
                // Verificar diferentes tipos de conflicto
                const validationResult = validatePlayerRegistration(data, seasonId);
                
                if (!validationResult.canRegister) {
                    displayPlayerError(validationResult.message);
                    disableFormSubmission();
                    return;
                } else {
                    if (validationResult.severity === 'info') {
                        displayPlayerInfo(validationResult.message);
                    } else {
                        displayPlayerSuccess(validationResult.message);
                    }
                    enableFormSubmission();
                }
                
            } else {
                playerExists = false;
                playerData = null;
                displayPlayerSuccess('‚úÖ Jugador nuevo - se crear√° un registro');
                enableAllSeasons(); // Habilitar todas las temporadas
                enableFormSubmission();
            }
        } catch (error) {
            console.error('Error checking player:', error);
            displayPlayerError('‚ùå ERROR: No se pudo verificar el jugador. Revise su conexi√≥n.');
            disableFormSubmission();
        }
        
        // Validar formulario despu√©s de verificar jugador
        validateForm();
    }

    // Nueva funci√≥n para deshabilitar temporadas donde el jugador ya est√° registrado
    function disableOccupiedSeasons(data) {
        const seasonSelect = document.getElementById('season_id');
        const options = seasonSelect.querySelectorAll('option');
        
        // Primero habilitar todas las opciones
        options.forEach(option => {
            if (option.value) { // No tocar la opci√≥n vac√≠a
                option.disabled = false;
                option.classList.remove('text-error', 'line-through');
            }
        });
        
        // Si hay registro actual, deshabilitar esa temporada/categor√≠a
        if (data.current_registration) {
            const currentSeasonId = data.current_registration.season.id.toString();
            const currentCategory = data.current_registration.season.category;
            
            options.forEach(option => {
                if (option.value) {
                    const optionSeasonId = option.value;
                    const optionCategory = option.dataset.category;
                    
                    // Deshabilitar si es la misma temporada y categor√≠a
                    if (optionSeasonId === currentSeasonId || optionCategory === currentCategory) {
                        option.disabled = true;
                        option.classList.add('text-error', 'line-through');
                        const clubName = data.current_registration.club.name;
                        option.textContent = `${option.textContent.split(' - ')[0]} - (Ya registrado en ${clubName})`;
                    }
                }
            });
        }
        
        // Verificar si hay conflicto de categor√≠a y deshabilitar
        if (data.category_conflict && data.category_conflict.exists) {
            const conflictCategory = data.category_conflict.season.category;
            
            options.forEach(option => {
                if (option.value && option.dataset.category === conflictCategory) {
                    option.disabled = true;
                    option.classList.add('text-error', 'line-through');
                    if (!option.textContent.includes('Ya registrado')) {
                        const clubName = data.category_conflict.club.name;
                        option.textContent = `${option.textContent.split(' - ')[0]} - (Ya registrado en ${clubName})`;
                    }
                }
            });
        }
    }

    // Nueva funci√≥n para habilitar todas las temporadas
    function enableAllSeasons() {
        const seasonSelect = document.getElementById('season_id');
        const options = seasonSelect.querySelectorAll('option');
        
        options.forEach(option => {
            if (option.value) {
                option.disabled = false;
                option.classList.remove('text-error', 'line-through');
                // Restaurar texto original
                const parts = option.textContent.split(' - ');
                if (parts.length > 2 || option.textContent.includes('Ya registrado')) {
                    // Restaurar desde el dataset o reconstruir
                    const category = option.dataset.category;
                    const seasonName = parts[parts.length - 1].replace(/\s*\(Ya registrado.*\)/, '').trim();
                    option.textContent = `${category} - ${seasonName}`;
                }
            }
        });
    }

    // Nueva funci√≥n para actualizar formulario with datos del jugador
    function updateFormWithPlayerData(player) {
        document.getElementById('first_name').value = player.first_name || '';
        document.getElementById('last_name').value = player.last_name || '';
        if (player.birth_date) {
            document.getElementById('birth_date').value = player.birth_date;
            // Actualizar la edad mostrada
            displayAge();
        }
    }

    // Nueva funci√≥n para validar el estado del registro del jugador
    function validatePlayerRegistration(data, currentSeasonId) {
        const player = data.player;
        const currentRegistration = data.current_registration;
        const categoryConflict = data.category_conflict;
        const lastRegistration = data.last_registration;

        // 1. Verificar conflicto directo de categor√≠a/temporada
        if (categoryConflict && categoryConflict.exists) {
            return {
                canRegister: false,
                message: `‚ö†Ô∏è CONFLICTO: ${player.full_name} ya est√° registrado en ${categoryConflict.season.category} con ${categoryConflict.club.name}`,
                severity: 'error'
            };
        }

        // 2. Verificar si tiene registro activo en la temporada actual
        if (currentRegistration && currentSeasonId && 
            currentRegistration.season.id.toString() === currentSeasonId) {
            
            const clubId = {{ club.id }};
            
            // Si est√° registrado en el mismo club y temporada
            if (currentRegistration.club.id === clubId) {
                return {
                    canRegister: false,
                    message: `‚ùå El jugador ${player.full_name} ya est√° registrado en esta temporada con este club (Estado: ${currentRegistration.status})`,
                    severity: 'error'
                };
            } else {
                // Registrado en otra temporada de la misma categor√≠a con otro club
                return {
                    canRegister: false,
                    message: `‚ö†Ô∏è CONFLICTO: ${player.full_name} ya est√° registrado en ${currentRegistration.season.category} con ${currentRegistration.club.name} (Estado: ${currentRegistration.status})`,
                    severity: 'error'
                };
            }
        }

        // 3. Si tiene registro activo pero en otra temporada/categor√≠a
        if (currentRegistration) {
            return {
                canRegister: true,
                message: `‚ÑπÔ∏è Jugador activo en ${currentRegistration.season.category} con ${currentRegistration.club.name} - Puede registrarse en nueva categor√≠a`,
                severity: 'info'
            };
        }

        // 4. Si no tiene registro activo pero tiene historial
        if (lastRegistration) {
            return {
                canRegister: true,
                message: `‚úÖ Jugador existente (√öltimo club: ${lastRegistration.club.name}) - Puede registrarse`,
                severity: 'success'
            };
        }

        // 5. Jugador existe pero nunca se ha registrado
        return {
            canRegister: true,
            message: `‚úÖ Jugador existente sin registros previos - Puede registrarse`,
            severity: 'success'
        };
    }

    // Funciones mejoradas para mostrar diferentes tipos de mensajes usando solo Tailwind y DaisyUI
    function displayPlayerError(message) {
        const element = document.getElementById('player-check-message');
        element.innerHTML = message;
        element.className = 'alert alert-error text-sm py-2 px-3 rounded-lg';
    }

    function displayPlayerSuccess(message) {
        const element = document.getElementById('player-check-message');
        element.innerHTML = message;
        element.className = 'alert alert-success text-sm py-2 px-3 rounded-lg';
    }

    function displayPlayerInfo(message) {
        const element = document.getElementById('player-check-message');
        element.innerHTML = message;
        element.className = 'alert alert-info text-sm py-2 px-3 rounded-lg';
    }

    function displayPlayerWarning(message) {
        const element = document.getElementById('player-check-message');
        element.innerHTML = message;
        element.className = 'alert alert-warning text-sm py-2 px-3 rounded-lg';
    }

    function resetPlayerValidation() {
        const element = document.getElementById('player-check-message');
        element.textContent = 'Se verificar√° si el jugador ya existe';
        element.className = 'label-text-alt text-info';
        enableFormSubmission();
    }

    function disableFormSubmission() {
        const saveBtn = document.getElementById('save-btn');
        const saveAndNewBtn = document.getElementById('save-and-new-btn');
        
        if (saveBtn && saveAndNewBtn) {
            saveBtn.disabled = true;
            saveAndNewBtn.disabled = true;
            saveBtn.classList.add('btn-disabled');
            saveAndNewBtn.classList.add('btn-disabled');
        }
        
        formIsValid = false;
    }

    function enableFormSubmission() {
        const saveBtn = document.getElementById('save-btn');
        const saveAndNewBtn = document.getElementById('save-and-new-btn');
        
        // Solo habilitar si no hay otros errores de validaci√≥n
        if (formIsValid !== false && saveBtn && saveAndNewBtn) {
            saveBtn.disabled = false;
            saveAndNewBtn.disabled = false;
            saveBtn.classList.remove('btn-disabled');
            saveAndNewBtn.classList.remove('btn-disabled');
        }
    }

    // Mostrar/ocultar campo de club anterior basado solo en el checkbox "have_pass"
    function toggleBeforeClub() {
        const havePassCheckbox = document.getElementById('have_pass');
        const container = document.getElementById('before_club_container');
        
        if (havePassCheckbox && container) {
            container.style.display = havePassCheckbox.checked ? 'block' : 'none';
        }
    }

    // Funci√≥n para calcular edad
    function calculateAge(birthDate) {
        if (!birthDate) return null;
        const today = new Date();
        const birth = new Date(birthDate);
        let age = today.getFullYear() - birth.getFullYear();
        const monthDiff = today.getMonth() - birth.getMonth();
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
            age--;
        }
        return age;
    }

    // Nueva funci√≥n para mostrar la edad calculada
    function displayAge() {
        const birthDate = document.getElementById('birth_date').value;
        const ageDisplay = document.getElementById('age-display');
        const ageCategoryHint = document.getElementById('age-category-hint');
        
        if (!birthDate) {
            ageDisplay.textContent = '';
            ageCategoryHint.textContent = '';
            validateForm();
            return;
        }
        
        const age = calculateAge(birthDate);
        
        if (age !== null) {
            // Mostrar edad
            ageDisplay.textContent = `(${age} a√±os)`;
            
            // Determinar si es juvenil o adulto seg√∫n la categor√≠a seleccionada
            if (categoryRules) {
                // Determinar si es juvenil usando las reglas espec√≠ficas de cada categor√≠a
                let isYouth = false;
                let youthLabel = '';
                
                if (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') {
                    isYouth = age < 18;
                    youthLabel = 'menor de 18 a√±os';
                } else if (categoryRules.name === 'MASTER') {
                    isYouth = age >= 38 && age <= 39;
                    youthLabel = 'entre 38-39 a√±os';
                }
                
                if (isYouth) {
                    ageCategoryHint.textContent = `üë∂ Jugador Juvenil (${youthLabel})`;
                    ageCategoryHint.className = 'label-text-alt text-info font-medium';
                } else {
                    ageCategoryHint.textContent = 'üë§ Jugador Adulto';
                    ageCategoryHint.className = 'label-text-alt text-success font-medium';
                }
                
                // Verificar edad m√≠nima para otras categor√≠as
                if (categoryRules.minAge && age < categoryRules.minAge) {
                    ageCategoryHint.textContent = `‚ö†Ô∏è Edad insuficiente (m√≠nimo ${categoryRules.minAge} a√±os) - NO PUEDE CONTINUAR`;
                    ageCategoryHint.className = 'label-text-alt text-error font-bold text-base';
                }
            } else {
                // Si no hay categor√≠a seleccionada, solo mostrar si es menor o mayor de edad
                if (age < 18) {
                    ageCategoryHint.textContent = 'Menor de edad';
                    ageCategoryHint.className = 'label-text-alt text-info';
                } else {
                    ageCategoryHint.textContent = 'Mayor de edad';
                    ageCategoryHint.className = 'label-text-alt text-base';
                }
            }

            if (age < 18) {
                ageDisplay.className = 'label-text-alt text-info font-semibold';
            } else if (age >= 35) {
                ageDisplay.className = 'label-text-alt text-warning font-semibold';
            } else {
                ageDisplay.className = 'label-text-alt text-primary font-semibold';
            }
        } else {
            ageDisplay.textContent = '';
            ageCategoryHint.textContent = 'Fecha inv√°lida';
            ageCategoryHint.className = 'label-text-alt text-error';
        }
        
        // Actualizar el rango de n√∫meros permitidos
        updateNumberRange();
        
        // Validar formulario completo
        validateForm();
    }

    // Funci√≥n para actualizar informaci√≥n de categor√≠a
    function updateCategoryInfo() {
        const seasonSelect = document.getElementById('season_id');
        const selectedOption = seasonSelect.options[seasonSelect.selectedIndex];
        const categoryInfo = document.getElementById('category-info');
        const categoryDetails = document.getElementById('category-details');
        const numberInput = document.getElementById('number');
        const numberRangeHint = document.getElementById('number-range-hint');
        const birthDateInput = document.getElementById('birth_date');
        
        if (!selectedOption || !selectedOption.value) {
            categoryInfo.style.display = 'none';
            numberRangeHint.textContent = '';
            categoryRules = null;
            displayAge();
            return;
        }
        
        // Verificar si la opci√≥n est√° deshabilitada
        if (selectedOption.disabled) {
            displayPlayerError('‚ö†Ô∏è No puede seleccionar esta temporada. El jugador ya est√° registrado en esta categor√≠a.');
            categoryInfo.style.display = 'none';
            disableFormSubmission();
            return;
        }
        
        // Obtener datos de la categor√≠a
        categoryRules = {
            name: selectedOption.dataset.category,
            minAge: parseInt(selectedOption.dataset.minAge) || null,
            maxPlayers: parseInt(selectedOption.dataset.maxPlayers),
            maxYouth: parseInt(selectedOption.dataset.maxYouth),
            minYouthNum: parseInt(selectedOption.dataset.minYouthNum),
            maxYouthNum: parseInt(selectedOption.dataset.maxYouthNum),
            minAdultNum: parseInt(selectedOption.dataset.minAdultNum),
            maxAdultNum: parseInt(selectedOption.dataset.maxAdultNum)
        };
        
        // Actualizar informaci√≥n visible
        let details = [];
        details.push(`<li>‚Ä¢ M√°ximo de jugadores: ${categoryRules.maxPlayers}</li>`);
        if (categoryRules.minAge) {
            details.push(`<li>‚Ä¢ Edad m√≠nima: ${categoryRules.minAge} a√±os</li>`);
        }
        details.push(`<li>‚Ä¢ N√∫meros adultos: ${categoryRules.minAdultNum} - ${categoryRules.maxAdultNum}</li>`);
        details.push(`<li>‚Ä¢ N√∫meros juveniles (menores 18): ${categoryRules.minYouthNum} - ${categoryRules.maxYouthNum}</li>`);
        details.push(`<li>‚Ä¢ M√°ximo juveniles: ${categoryRules.maxYouth}</li>`);
        
        categoryDetails.innerHTML = details.join('');
        categoryInfo.style.display = 'flex';
        
        // Actualizar display de edad con las nuevas reglas de categor√≠a
        displayAge();
        
        // Actualizar rango de n√∫meros seg√∫n edad
        updateNumberRange();
        
        // Re-verificar jugador con nueva temporada si hay c√©dula
        const nationalIdInput = document.getElementById('national_id');
        if (nationalIdInput.value && nationalIdInput.value.length >= 10) {
            checkPlayerExists(nationalIdInput.value);
        }
    }
    
    // Funci√≥n para actualizar el rango de n√∫meros permitidos
    function updateNumberRange() {
        if (!categoryRules) return;
        
        const birthDate = document.getElementById('birth_date').value;
        const numberInput = document.getElementById('number');
        const numberRangeHint = document.getElementById('number-range-hint');
        const minorRequired = document.getElementById('minor-required');
        const minorHint = document.getElementById('minor-hint');
        
        const age = calculateAge(birthDate);
        let isYouth = false;
        
        // Determinar si es juvenil seg√∫n las reglas espec√≠ficas de cada categor√≠a
        if (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') {
            isYouth = age !== null && age < 18;
        } else if (categoryRules.name === 'MASTER') {
            isYouth = age !== null && age >= 38 && age <= 39;
        }
        
        if (isYouth) {
            numberInput.min = categoryRules.minYouthNum;
            numberInput.max = categoryRules.maxYouthNum;
            numberRangeHint.textContent = `(${categoryRules.minYouthNum} - ${categoryRules.maxYouthNum})`;
            numberRangeHint.className = 'label-text-alt text-info';
            
            // Hacer obligatoria la autorizaci√≥n solo para menores de 18 a√±os
            if (age !== null && age < 18) {
                minorRequired.style.display = 'inline';
                minorHint.textContent = 'Obligatorio para menores de 18 a√±os';
                minorHint.className = 'label-text-alt text-warning';
            } else {
                minorRequired.style.display = 'none';
                minorHint.textContent = 'JPG, PNG, PDF (Max: 5MB)';
                minorHint.className = 'label-text-alt';
            }
        } else {
            numberInput.min = categoryRules.minAdultNum;
            numberInput.max = categoryRules.maxAdultNum;
            numberRangeHint.textContent = `(${categoryRules.minAdultNum} - ${categoryRules.maxAdultNum})`;
            numberRangeHint.className = 'label-text-alt';
            
            // Quitar obligatoriedad de autorizaci√≥n
            minorRequired.style.display = 'none';
            minorHint.textContent = 'JPG, PNG, PDF (Max: 5MB)';
            minorHint.className = 'label-text-alt';
        }
        
        // Validar n√∫mero actual
        validateNumber();
    }
    
    // Funci√≥n para validar todo el formulario
    function validateForm() {
        const saveBtn = document.getElementById('save-btn');
        const saveAndNewBtn = document.getElementById('save-and-new-btn');
        const birthDate = document.getElementById('birth_date').value;
        const seasonId = document.getElementById('season_id').value;
        const numberInput = document.getElementById('number');
        const number = parseInt(numberInput.value);
        const nationalId = document.getElementById('national_id').value;
        
        let isValid = true;
        let errorMessages = [];

        // Validar campos obligatorios
        if (!nationalId || nationalId.length < 10) {
            isValid = false;
            errorMessages.push('C√©dula debe tener 10 d√≠gitos');
        }

        // Validar que haya temporada seleccionada
        if (!seasonId || !categoryRules) {
            isValid = false;
            errorMessages.push('Debe seleccionar una temporada');
        }
        
        // Validar edad m√≠nima si la categor√≠a lo requiere
        if (categoryRules && categoryRules.minAge && birthDate) {
            const age = calculateAge(birthDate);
            if (age !== null && age < categoryRules.minAge) {
                isValid = false;
                errorMessages.push(`El jugador debe tener al menos ${categoryRules.minAge} a√±os`);
            }
        }

        // Validar si el jugador tiene conflictos de registro
        if (playerExists && playerData) {
            // Si el endpoint devolvi√≥ un conflicto de categor√≠a, bloquear
            if (playerData.category_conflict && playerData.category_conflict.exists) {
                isValid = false;
                errorMessages.push('Jugador ya registrado en esta categor√≠a');
            }
            
            // Si est√° registrado en la misma temporada
            if (playerData.current_registration && 
                playerData.current_registration.season.id.toString() === seasonId) {
                isValid = false;
                errorMessages.push('Jugador ya registrado en esta temporada');
            }
        }
        
        // Validar n√∫mero
        if (categoryRules && number) {
            const age = calculateAge(birthDate);
            
            // Determinar si es juvenil seg√∫n las reglas espec√≠ficas de cada categor√≠a
            let isYouth = false;
            if (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') {
                isYouth = age !== null && age < 18;
            } else if (categoryRules.name === 'MASTER') {
                isYouth = age !== null && age >= 38 && age <= 39;
            }
            
            if (isYouth) {
                if (number < categoryRules.minYouthNum || number > categoryRules.maxYouthNum) {
                    isValid = false;
                    errorMessages.push(`N√∫mero debe estar entre ${categoryRules.minYouthNum} y ${categoryRules.maxYouthNum} (juvenil)`);
                }
            } else {
                if (number < categoryRules.minAdultNum || number > categoryRules.maxAdultNum) {
                    isValid = false;
                    errorMessages.push(`N√∫mero debe estar entre ${categoryRules.minAdultNum} y ${categoryRules.maxAdultNum} (adulto)`);
                }
            }
            
            // Verificar si el n√∫mero tiene la clase input-error (ya est√° asignado)
            if (numberInput.classList.contains('input-error')) {
                isValid = false;
                errorMessages.push('El n√∫mero ya est√° asignado');
            }
        }
        
        // Actualizar estado de los botones
        if (isValid) {
            saveBtn.disabled = false;
            saveAndNewBtn.disabled = false;
            saveBtn.classList.remove('btn-disabled');
            saveAndNewBtn.classList.remove('btn-disabled');
            formIsValid = true;
        } else {
            saveBtn.disabled = true;
            saveAndNewBtn.disabled = true;
            saveBtn.classList.add('btn-disabled');
            saveAndNewBtn.classList.add('btn-disabled');
            formIsValid = false;
            
            // Mostrar tooltip con errores
            if (errorMessages.length > 0) {
                const errorText = 'Errores:\n' + errorMessages.join('\n');
                saveBtn.title = errorText;
                saveAndNewBtn.title = errorText;
            }
        }
        
        return isValid;
    }
    
    // Funci√≥n para validar n√∫mero de jugador
    async function validateNumber() {
        const numberInput = document.getElementById('number');
        const number = parseInt(numberInput.value);
        const validationMsg = document.getElementById('number-validation-msg');
        const seasonId = document.getElementById('season_id').value;
        const clubId = {{ club.id }};
        
        if (!number || !seasonId || !categoryRules) {
            validationMsg.textContent = '';
            validateForm();
            return;
        }
        
        // Verificar rango local primero
        const birthDate = document.getElementById('birth_date').value;
        const age = calculateAge(birthDate);
        
        // Determinar si es juvenil seg√∫n las reglas espec√≠ficas de cada categor√≠a
        let isYouth = false;
        if (categoryRules.name === 'SENIOR' || categoryRules.name === 'FEMENINO') {
            isYouth = age !== null && age < 18;
        } else if (categoryRules.name === 'MASTER') {
            isYouth = age !== null && age >= 38 && age <= 39;
        }
        
        let validRange = true;
        if (isYouth) {
            validRange = number >= categoryRules.minYouthNum && number <= categoryRules.maxYouthNum;
            if (!validRange) {
                validationMsg.textContent = `N√∫mero fuera del rango juvenil (${categoryRules.minYouthNum} - ${categoryRules.maxYouthNum})`;
                validationMsg.className = 'label-text-alt text-error font-bold';
                numberInput.classList.add('input-error');
                numberInput.classList.remove('input-success');
                validateForm();
                return;
            }
        } else {
            validRange = number >= categoryRules.minAdultNum && number <= categoryRules.maxAdultNum;
            if (!validRange) {
                validationMsg.textContent = `N√∫mero fuera del rango adulto (${categoryRules.minAdultNum} - ${categoryRules.maxAdultNum})`;
                validationMsg.className = 'label-text-alt text-error font-bold';
                numberInput.classList.add('input-error');
                numberInput.classList.remove('input-success');
                validateForm();
                return;
            }
        }
        
        // Verificar disponibilidad del n√∫mero con llamada AJAX
        try {
            validationMsg.textContent = 'Verificando disponibilidad...';
            validationMsg.className = 'label-text-alt text-info';
            
            const response = await fetch(`/api/check-player-number/?number=${number}&season_id=${seasonId}&club_id=${clubId}`);
            const data = await response.json();
            
            if (data.success) {
                if (data.available) {
                    validationMsg.textContent = '‚úì N√∫mero disponible';
                    validationMsg.className = 'label-text-alt text-success font-semibold';
                    numberInput.classList.remove('input-error');
                    numberInput.classList.add('input-success');
                } else {
                    validationMsg.textContent = `‚úó ${data.message}`;
                    validationMsg.className = 'label-text-alt text-error font-semibold';
                    numberInput.classList.remove('input-success');
                    numberInput.classList.add('input-error');
                }
                
                // Mostrar advertencia si est√° fuera de rango
                if (data.warning) {
                    validationMsg.textContent += ` - ${data.warning}`;
                }
            } else {
                validationMsg.textContent = data.error || 'Error al verificar el n√∫mero';
                validationMsg.className = 'label-text-alt text-error';
                numberInput.classList.remove('input-success');
                numberInput.classList.add('input-error');
            }
        } catch (error) {
            console.error('Error checking number:', error);
            validationMsg.textContent = 'Error de conexi√≥n al verificar n√∫mero';
            validationMsg.className = 'label-text-alt text-warning';
        } finally {
            // Validar formulario completo despu√©s de verificar n√∫mero
            validateForm();
        }
    }

    // Ejecutar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        toggleBeforeClub();
        updateCategoryInfo();
        displayAge(); // Mostrar edad si ya hay fecha cargada
        validateForm(); // Validar formulario al cargar
        
        // Agregar listener al checkbox have_pass
        const havePassCheckbox = document.getElementById('have_pass');
        if (havePassCheckbox) {
            havePassCheckbox.addEventListener('change', toggleBeforeClub);
        }
        
        // Agregar listener para cambio de temporada
        const seasonSelect = document.getElementById('season_id');
        if (seasonSelect) {
            seasonSelect.addEventListener('change', function() {
                updateCategoryInfo();
                validateForm(); // Validar al cambiar temporada
            });
        }
        
        // Agregar listener para cambio de fecha de nacimiento
        const birthDateInput = document.getElementById('birth_date');
        if (birthDateInput) {
            birthDateInput.addEventListener('change', function() {
                displayAge();
            });
            // Tambi√©n actualizar cuando se escribe
            birthDateInput.addEventListener('input', function() {
                displayAge();
            });
        }
        
        // Agregar listener para validar n√∫mero con debounce
        const numberInput = document.getElementById('number');
        if (numberInput) {
            numberInput.addEventListener('input', function() {
                // Limpiar timeout anterior
                clearTimeout(numberCheckTimeout);
                
                // Limpiar clases de validaci√≥n
                this.classList.remove('input-success', 'input-error');
                
                // Verificar despu√©s de 500ms de inactividad
                numberCheckTimeout = setTimeout(() => {
                    validateNumber();
                }, 500);
            });
        }
        
        // Agregar listener para verificar jugador
        const nationalIdInput = document.getElementById('national_id');
        nationalIdInput.addEventListener('input', function(e) {
            // Limpiar timeout anterior
            clearTimeout(playerCheckTimeout);
            
            // Validar solo n√∫meros
            this.value = this.value.replace(/[^0-9]/g, '');
            
            // Opcional: Validar longitud para c√©dula ecuatoriana
            if (this.value.length > 10) {
                this.value = this.value.slice(0, 10);
            }
            
            // Verificar jugador despu√©s de 500ms de inactividad
            playerCheckTimeout = setTimeout(() => {
                checkPlayerExists(this.value);
            }, 500);
        });
        
        // Prevenir env√≠o si el formulario no es v√°lido
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (!formIsValid) {
                    e.preventDefault();
                    
                    let alertMessage = 'Por favor, corrija los errores antes de continuar:\n\n';
                    
                    // Verificar tipos espec√≠ficos de error
                    if (playerExists && playerData) {
                        if (playerData.category_conflict && playerData.category_conflict.exists) {
                            alertMessage += '- El jugador ya est√° registrado en esta categor√≠a con otro club\n';
                        }
                        if (playerData.current_registration) {
                            const currentReg = playerData.current_registration;
                            const seasonId = document.getElementById('season_id').value;
                            if (currentReg.season.id.toString() === seasonId) {
                                alertMessage += `- El jugador ya est√° registrado en esta temporada (${currentReg.status})\n`;
                            }
                        }
                    }
                    
                    if (categoryRules && categoryRules.minAge) {
                        const age = calculateAge(document.getElementById('birth_date').value);
                        if (age !== null && age < categoryRules.minAge) {
                            alertMessage += `- El jugador debe tener al menos ${categoryRules.minAge} a√±os\n`;
                        }
                    }
                    
                    if (document.getElementById('number').classList.contains('input-error')) {
                        alertMessage += '- El n√∫mero seleccionado no est√° disponible o est√° fuera del rango permitido\n';
                    }
                    
                    alert(alertMessage);
                    return false;
                }
            });
        }
    });
</script>
{% endblock %}
